$(function(){$("#side-nav a").click(function(){$(this).parents("#side-nav").toggleClass("active")}),$("#nav-btn").click(function(){$(this).parents("#side-nav").toggleClass("active")}),$('a[data-toggle="tab"]').on("show.bs.tab",function(t){"#tab-slot"==$(t.target).attr("href")&&(slot.init(),Flapper.init())}),$("#giftBox, #peopleBox").on("loaded",function(){var t=$(this);$(this).find("ul").sortable({update:function(i,n){var s=[];return $(this).find("li").each(function(){var t=$(this).text();s.push(t)}),t.trigger("sortItems",[s]),!1}}).disableSelection()}),$("#award-clear").click(function(){slot.clearResult(),location.reload()})});var Flapper={isInit:!1,container:"#flapper",element:"input.display",options:{chars_preset:"alpha",chars:[" ","王","李","張","趙","劉","陳","楊","吳","黃","朱"],align:"left",width:3,timing:500,min_timing:10},init:function(){if(this.isInit)return!0;this.isInit=!0;var t=this;this.options.on_anim_start=function(){var i=$(t.element,t.container).val();$(t.container).trigger("anim_start",[i])},this.options.on_anim_end=function(){var i=$(t.element,t.container).val();$(t.container).trigger("anim_end",[i])},$(this.container).on("updateStr",function(i,n){t.updateStr(n)}),$(this.element,this.container).val("").flapper(this.options)},updateStr:function(t){var i=$(this.element,this.container);i.val().length&&i.val("").change(),t&&t.length&&i.val(t).change()}};!function(t){var n="Flap",s={},e=function(i,e){var o=this;this.id=Math.floor(1e3*Math.random())+1,this.$ele=i,this.options=t.extend({},this.defaults,e),this.options.transform=this.options.transform&&t.transform,this.$div=t("<div></div>"),this.$div.attr("class","flapper "+this.$ele.attr("class")),this.$ele.hide().after(this.$div),this.$ele.bind("change.flapper",function(){o.update()});var a=this.$ele[0].id||n+this.id;this.$ele.attr("id",a),s[a]=this,this.init()};e.prototype={defaults:{width:6,format:null,align:"right",padding:" ",chars:null,chars_preset:"num",timing:250,min_timing:10,threshhold:100,transform:!0,on_anim_start:null,on_anim_end:null},init:function(){var t=this;for(this.digits=[],i=0;i<this.options.width;i++)this.digits[i]=new FlapDigit(null,this.options),this.$div.append(this.digits[i].$ele);this.$div.on("digitAnimEnd",function(i){t.onDigitAnimEnd(i)}),this.options.on_anim_start&&this.$div.on("animStart",this.options.on_anim_start),this.options.on_anim_end&&this.$div.on("animEnd",this.options.on_anim_end),this.update()},update:function(){var t=this.$ele.val().replace(/[\s|\u00a0]/g," "),i=this.getDigits(t);this.digitsFinished=0,this.$div.trigger("animStart");for(var n=0;n<this.digits.length;n++)this.digits[n].goToChar(i[n])},onDigitAnimEnd:function(t){this.digitsFinished++,this.digitsFinished==this.options.width&&this.$div.trigger("animEnd")},getDigits:function(i,n){var s=i+"";this.options.format&&(s=t.formatNumber(i,this.options.format));var e=s.split("");if(e.length<this.options.width)for(;e.length<this.options.width;)"left"==this.options.align?e.push(this.options.padding):e.unshift(this.options.padding);else if(e.length>this.options.width){var o=e.length-this.options.width;"left"==this.options.align?e.splice(-1,o):e.splice(0,o)}return e},addDigit:function(){var t=new FlapDigit(null,this.options);return"left"===this.options.align?(this.digits.push(t),this.$div.append(t.$ele)):(this.digits.unshift(t),this.$div.prepend(t.$ele)),this.options.width=this.digits.length,t},removeDigit:function(){var t="left"===this.options.align?this.digits.pop():this.digits.shift();t.$ele.remove(),this.options.width=this.digits.length},performAction:function(t){switch(t){case"add-digit":this.addDigit();break;case"remove-digit":this.removeDigit()}}},FlapDigit=function(i,n){this.options=n,this.options.chars||(this.options.chars=this.presets[this.options.chars_preset]),this.pos=0,this.timeout,i?this.$ele=i:this.$ele=t(this.htmlTemplate),this.$prev=this.$ele.find(".front.top, .back.bottom"),this.$next=this.$ele.find(".back.top, .front.bottom"),this.$back_top=this.$ele.find(".back.top"),this.$back_bottom=this.$ele.find(".back.bottom"),this.$front_top=this.$ele.find(".front.top"),this.$front_bottom=this.$ele.find(".front.bottom"),this.initialize()},FlapDigit.prototype={presets:{num:[" ","1","2","3","4","5","6","7","8","9","0"],hexnum:[" ","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","0"],alpha:[" ","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],alphanum:[" ","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","1","2","3","4","5","6","7","8","9","0"]},initialize:function(){this.$prev.html(this.options.chars[0]),this.$next.html(this.options.chars[0])},htmlTemplate:'<div class="digit"><div class="back top">&nbsp;</div><div class="back bottom">&nbsp;</div><div class="front top">&nbsp;</div><div class="front bottom">&nbsp;</div></div>',increment:function(t){var i=this.pos+1;i>=this.options.chars.length&&(i=0),this.$prev.html(this.options.chars[this.pos]).show(),this.$front_bottom.hide(),this.$next.html(this.options.chars[i]);var n=Math.floor(Math.random()*t*.4+.3*t),s=Math.floor(Math.random()*t*.1+.2*t);t>=this.options.threshhold&&(this.options.transform?this.animateSlow(n,s):this.animateFast(n,s)),this.pos=i},animateSlow:function(t,i){var n=this;this.$back_top.show(),this.$front_bottom.transform({scaleY:0}),this.$front_top.transform({scaleY:1}).stop().show().animate({scaleY:0},t,"swing",function(){n.$front_bottom.stop().show().animate({scaleY:1},i,"linear"),n.$front_top.hide().transform({scaleY:1})})},animateFast:function(t,i){var n=this;this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(function(){n.$front_top.hide(),n.timeout=setTimeout(function(){n.$front_bottom.show()},i)},t)},goToPosition:function(t){var i=this,n=function(){i.timing_timer&&(clearInterval(i.timing_timer),i.timing_timer=null);var s=t-i.pos;if(0>s&&(s+=i.options.chars.length),i.pos==t)clearInterval(i.timing_timer),i.timing_timer=null,i.$ele.trigger("digitAnimEnd");else{var e=Math.floor((i.options.timing-i.options.min_timing)/s+i.options.min_timing);i.increment(e),i.timing_timer=setTimeout(n,e)}};n()},goToChar:function(i){var n=t.inArray(i,this.options.chars);-1==n&&(this.options.chars.push(i),n=this.options.chars.length-1),this.goToPosition(n)}},t.fn.flapper=function(i){return this.each(function(){return"string"==typeof i||i instanceof String?void(this.id&&s.hasOwnProperty(this.id)&&s[this.id].performAction(i)):new e(t(this),i)}),this}}(jQuery);var slot={isInit:!1,awards:{},gifts:[],people:[],nextGift:"",giftNameElement:"#gift .name",flapperElement:"#flapper",container:"#tab-slot",btnStart:"#btn-start",btnNext:"#btn-next-gift",btnReroll:"#btn-reroll",init:function(){return this.awards=localStorage.awards?JSON.parse(localStorage.awards):{},this.gifts=localStorage.gifts?JSON.parse(localStorage.gifts):[],this.people=localStorage.people?JSON.parse(localStorage.people):[],this.removeRolledAward(),this.gifts.length&&this.people.length?this.isInit?!0:(this.isInit=!0,this.registerEvent(),this.prepareNextRoll(),this.disableStartBtn(!1),this.disableNextBtn(!0),void this.disableRerollBtn(!0)):(this.disableStartBtn(!0),!1)},removeRolledAward:function(){for(award in this.awards){var t=this.awards[award],i=this.gifts.indexOf(award),n=this.people.indexOf(t);i>=0&&this.gifts.splice(i,1),n>=0&&this.people.splice(n,1)}},registerEvent:function(){var t=this;$(t.btnStart).click(function(){t.roll()}),$(t.btnNext).click(function(){t.prepareNextRoll()}),$(t.btnReroll).click(function(){t.reRoll()}),$(t.flapperElement).on("anim_start",function(i,n){return n.length?(t.disableStartBtn(!0),t.disableNextBtn(!0),void t.disableRerollBtn(!0)):!1}),$(t.flapperElement).on("anim_end",function(i,n){return n.length&&t.gifts.length&&t.people.length?(t.disableNextBtn(!1),t.disableRerollBtn(!1),!1):void 0})},disableStartBtn:function(t){t?$(this.btnStart).attr("disabled",!0):$(this.btnStart).removeAttr("disabled")},disableNextBtn:function(t){t?$(this.btnNext).attr("disabled",!0):$(this.btnNext).removeAttr("disabled")},disableRerollBtn:function(t){t?$(this.btnReroll).attr("disabled",!0):$(this.btnReroll).removeAttr("disabled")},prepareNextRoll:function(){this.nextGift=this.gifts.shift(),$(this.giftNameElement).text(this.nextGift),$(this.flapperElement).trigger("updateStr",[""]),this.disableStartBtn(!1),this.disableNextBtn(!0),this.disableRerollBtn(!0)},roll:function(){var t=this.people.length,i=Math.floor(Math.random()*t),n=this.people.splice(i,1).pop();this.awards[this.nextGift]=n,$(this.flapperElement).trigger("updateStr",[n]),this.saveResult()},reRoll:function(){var t=this.awards[this.nextGift];this.people.splice(0,0,t),this.roll()},saveResult:function(){localStorage.awards=JSON.stringify(this.awards),$(this.container).trigger("updateAwards")},clearResult:function(){delete localStorage.awards,this.awards={}}};